<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile | Project Collaborator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/dashboard.css">
</head>

<body class="bg-primary text-primary">
    <!-- Navbar -->
    <nav class="flex justify-between items-center px-4 md:px-6 py-3 sticky top-0 z-40 border-b bg-secondary border-primary">
        <div class="text-lg md:text-xl font-semibold text-primary">
            Project Collaborator
        </div>
        <div class="flex items-center gap-4">
            <a href="/dashboard" class="text-sm text-secondary hover:text-primary transition-colors">Dashboard</a>
            <a href="/chat" class="text-sm text-secondary hover:text-primary transition-colors">Chat</a>
            <a href="/dashboard" class="text-sm text-secondary link-cyan">‚Üê Back</a>
        </div>
    </nav>
    
    <!-- User Info -->
    <div class="container mx-auto max-w-4xl px-4 py-8">
        <div class="text-center mb-8">
            <img th:src="${avatar}" alt="User Avatar" class="w-20 h-20 rounded-full mx-auto border object-cover mb-4 border-primary">
            <h2 id="ownerName" th:text="${username}" class="text-xl font-semibold mb-4 text-primary"></h2>
            <button onclick="logout()" class="btn-secondary">
                Logout
            </button>
        </div>

        <!-- Incoming Requests Section -->
        <div class="card">
            <h3 class="text-lg font-semibold mb-4 text-primary">
                Incoming Requests
            </h3>

            <div id="requestList" class="space-y-3">
                <div class="text-center py-8">
                    <div class="loading">Loading requests...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Logout function
        function logout() {
            window.location.href = "/logout";
        }

        // Fetch incoming collaboration requests
        async function loadRequests() {
            const owner = document.getElementById("ownerName").innerText;

            const response = await fetch(`/projects/requests/${owner}`);
            const requests = await response.json();

            const container = document.getElementById("requestList");
            container.innerHTML = ""; // clear old items

            if (!requests.length) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-sm text-secondary">No collaboration requests yet</p>
                    </div>
                `;
                return;
            }

            requests.forEach((req, index) => {
                // Create request card
                const div = document.createElement("div");
                div.className = "card fade-in";
                div.style.animationDelay = `${index * 0.1}s`;

                // Use status badge classes with accent colors
                const statusBadge = req.status === "pending" ? 
                    '<span class="badge-status-pending">Pending</span>' :
                    req.status === "accepted" ?
                    '<span class="badge-status-accepted">Accepted</span>' :
                    '<span class="badge-status-rejected">Rejected</span>';

                div.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium bg-tertiary text-primary">
                                ${escapeHtml(req.requester.charAt(0).toUpperCase())}
                            </div>
                            <div>
                                <p class="font-medium text-sm text-primary">${escapeHtml(req.requester)}</p>
                                <p class="text-xs text-secondary">Project ID: ${req.projectId}</p>
                            </div>
                        </div>
                        ${statusBadge}
                    </div>

                    ${
                        req.status === "pending"
                        ? `
                        <div class="flex gap-2">
                            <button onclick="accept(${req.id})" class="flex-1 btn-primary">
                                Accept
                            </button>
                            <button onclick="reject(${req.id})" class="flex-1 btn-secondary">
                                Reject
                            </button>
                        </div>
                        `
                        : ""
                    }
                `;

                container.appendChild(div);
            });
        }

        // Accept request
        async function accept(id) {
            try {
                await fetch(`/projects/requests/accept/${id}`, { method: "PUT" });
                loadRequests(); // refresh list
            } catch (err) {
                console.error(err);
                alert("Failed to accept request");
            }
        }

        // Reject request
        async function reject(id) {
            try {
                await fetch(`/projects/requests/reject/${id}`, { method: "PUT" });
                loadRequests(); // refresh list
            } catch (err) {
                console.error(err);
                alert("Failed to reject request");
            }
        }

        // Load request list when profile opens
        window.onload = loadRequests;
    </script>

</body>
</html>
